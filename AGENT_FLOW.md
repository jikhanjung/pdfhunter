# Agent Flow – 서지 정보 자동 추출 에이전트 실행 흐름

본 문서는 **서지 정보 자동 추출 에이전트**가 PDF 또는 이미지 입력을 받아
어떤 순서로 행동(action)을 수행하는지를 정의한다.

이 문서는 **결정 규칙(decision-policy.md)** 을 직접 포함하지 않으며,
모든 판단은 해당 문서를 참조하여 이루어진다.

---

## 1. 역할 분리 원칙

- 본 문서: *에이전트가 무엇을 언제 실행하는가*
- decision-policy.md: *어떤 정보를 신뢰하는가*

에이전트는 모든 단계에서 **결정 규약을 참조**해야 한다.

---

## 2. 입력과 출력

### 입력
- PDF 파일 (텍스트 PDF / 스캔 PDF / 하이브리드)
- 단일 이미지 (표지, 타이틀 페이지)

### 출력
- 서지 레코드 (CSL-JSON / RIS / BibTeX)
- evidence (근거 데이터)
- status: confirmed / needs_review / failed

---

## 3. 초기 파일 분석

### 목적
문서 상태를 빠르게 파악하여 이후 경로를 결정한다.

### 수행 항목
- 페이지 수 계산
- 파일명 / 생성일 확인
- 텍스트 레이어 존재 여부 판정

### 분기
- 텍스트 충분 → 텍스트 우선 파이프라인
- 텍스트 없음/불량 → 이미지(OCR/Vision) 파이프라인

---

## 4. 정보 가능성 높은 페이지 선택

### 기본 선택 규칙
- 항상 포함: p1, p2, last

### 조건부 확장
- p3: 본문 시작 추정
- last-1: 콜로폰 가능성
- 목차 페이지: volume/issue 단서

선택 이유와 결과는 로그로 남긴다.

---

## 5. 페이지 렌더링

### 목적
Vision/OCR 입력과 evidence 저장을 위한 이미지 생성

### 정책
- 저해상도: 구조 탐지용
- 고해상도(200–300dpi): OCR 및 증거 저장용

---

## 6. 텍스트 확보

### 6.1 텍스트 PDF
- 직접 텍스트 추출
- 페이지별 저장

### 6.2 스캔 PDF
- 다국어 OCR 수행
- bounding box 포함 가능

---

## 7. Vision 기반 서지 추출 (Image-first)

### 목적
OCR 또는 텍스트 기반 추출이 불완전한 경우,
이미지 구조 인식을 통해 서지 정보를 직접 추출한다.

### 실행 조건
- 스캔 PDF
- OCR 품질 저하
- 핵심 필드 누락

### 입력
- p1 / p2 / last 이미지

### 출력
- 서지 필드 후보 + evidence

---

## 8. 1차 규칙 기반 추출

### 목적
확실한 필드를 빠르게 확보한다.

### 대상
- Year
- Pages
- Volume / Issue
- Series 정보

각 필드는 evidence와 함께 기록한다.

---

## 9. LLM 텍스트 구조화 추출

### 목적
규칙 기반으로 불완전한 필드를 보완한다.

### 실행 조건
- OCR/텍스트 충분
- 핵심 필드 일부 누락

### 입력 제한
- p1 / p2 / last 텍스트 중심

### 출력
- JSON 구조화 필드
- confidence + evidence

---

## 10. 외부 서지 DB 검증

### 목적
정규화 및 최종 검증

### 대상
- Crossref
- OpenAlex (선택)

결과는 후보로 추가되며,
최종 채택 여부는 decision-policy에 따른다.

---

## 11. 확장 탐색 루프 (Agent Loop)

### 목적
누락 필드를 자동으로 보완한다.

### 예시
- pages 누락 → 런닝 헤더 탐색
- publisher 누락 → last-1 추가
- volume/issue 누락 → 목차 페이지 탐색

### 제약
- 최대 반복 횟수 제한
- 실패 시 needs_review로 전환

---

## 12. 웹 검색 보강 (선택)

### 실행 조건
- 내부 정보만으로 확정 불가

### 전략
- title + author + year 검색
- 원어 제목 유지

웹 결과도 evidence로 저장한다.

---

## 13. 최종 상태 결정

결정은 decision-policy.md 규칙을 따른다.

- confirmed
- needs_review
- failed

---

## 14. 사용자 검수 UI 연결

### 구성
- 좌측: evidence 이미지
- 우측: 서지 필드 폼
- 상단: confidence 표시

### 액션
- 승인
- 수정 후 저장
- 웹검색 재시도
- 추가 OCR

---

## 15. 저장 및 내보내기

### 내부 저장
- records/{id}.csl.json
- evidence/{id}/

### 내보내기 포맷
- RIS
- BibTeX
- CSL-JSON

---

## 16. Design Notes

- 에이전트는 항상 **결정 규약을 참조**한다.
- 모든 자동 결과는 검수 가능해야 한다.
- 실패는 오류가 아니라 상태 중 하나이다.

---

(End of agent-flow.md)
