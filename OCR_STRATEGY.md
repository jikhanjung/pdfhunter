# OCR 전략 (서지 정보 자동 추출용)

이 문서는 **스캔 PDF(비OCR)** 또는 **품질이 낮은 OCR PDF**에서 서지 정보를 안정적으로 뽑기 위한 OCR 전략을 정리한다.  
목표는 “본문 전체 OCR”이 아니라, **서지에 필요한 짧은 텍스트(저자/제목/연도/저널·시리즈/권호/페이지/발행지·발행처)**를 **빠르고 재현성 있게** 얻는 것이다.

---

## 1. 기본 원칙

### 1) OCR은 한 번에 끝내지 않는다
- 서지 추출은 “전 페이지 OCR”이 필요 없다.
- 정보가 몰리는 페이지는 대체로 제한적이다.
- 따라서 **부분 OCR + 실패 시 폴백**이 비용/속도/정확도 모두에서 유리하다.

### 2) OCR 결과는 최종 답이 아니라 “후보 생성기”
- 최종 확정은 아래 요소의 조합이 담당한다.
  - 규칙 기반 검증(연도/페이지/권호 패턴)
  - LLM 구조화(저자/제목/컨테이너 정규화)
  - 웹 검색(권호·페이지 확정, 동형이의 제거)
  - 사용자 10초 검수

### 3) evidence(근거) 저장이 핵심
- OCR 텍스트만 저장하지 말고, 가능한 경우 **bbox(바운딩 박스)**와 함께 저장한다.
- 어떤 필드가 “어느 페이지의 어떤 문자열에서 나왔는지”를 남긴다.

---

## 2. 페이지 샘플링 전략 (스캔/비OCR PDF)

### 0단계: 항상 처리하는 페이지 (기본 3장)
- p1: 표지/타이틀
- p2: 타이틀 뒷면/시리즈·기관 정보/서문 시작
- last: 콜로폰/발행정보/인쇄정보(기관 총서에서 특히 중요)

### 1단계: 누락 필드에 따라 확장 (조건부)
- p3: 본문 시작 또는 런닝 헤더가 나오는 경우
- last-1: 콜로폰이 마지막에서 한 장 앞에 있는 경우
- 목차 페이지 후보: "Содержание / Sommaire / Contents"가 있는 페이지

#### 목차 페이지 탐지 방법
목차 페이지는 OCR 전에 다음 방법으로 탐지한다:
1. **레이아웃 분석 우선**: 페이지 상단 20% 영역만 저해상도 OCR(100dpi)로 키워드 탐지
2. **키워드 매칭**: `Содержание`, `Sommaire`, `Contents`, `Table of Contents`, `Оглавление`
3. **레이아웃 휴리스틱**: 점선(.....) 또는 탭 정렬된 숫자 패턴이 반복되는 페이지

### 2단계: 런닝 헤더 탐색(저널 논문에서 pages/volume 추출용)
- 랜덤 샘플 5~10페이지를 저해상도 렌더링으로 훑고,
- 상단/하단에 저널 약어, 연도, `p.` 패턴이 보이면 그 페이지만 고해상도 OCR

#### 런닝 헤더 탐색 적용 조건
이 단계는 비용이 있으므로 다음 조건을 **모두** 만족할 때만 수행한다:
1. 문서가 **저널 논문**으로 분류됨 (5단계에서 판정)
2. 기본 3장(p1/p2/last)에서 **pages 또는 volume/issue가 누락**됨
3. 문서 페이지 수가 **5페이지 이상**

단행본/보고서/시리즈로 분류된 경우 이 단계를 건너뛴다.

---

## 3. OCR 파이프라인 (권장: 2단계 + 폴백)

### 단계 A: OCR 전 탐지(저해상도, 빠름)
목표: “이 페이지에 서지 정보가 있을 확률”을 스코어링해 OCR 자원을 아낀다.
- 100~150dpi 렌더
- 가벼운 탐지
  - 연도 후보(19xx/20xx) 존재 가능성
  - 숫자 블록/하이픈(페이지 범위) 존재 가능성
  - 큰 제목 라인 존재 가능성(텍스트 밀도/레이아웃)

출력: `page_score` (0~1)

### 단계 B: 기본 OCR (로컬, 빠름)
기본 엔진으로 **PaddleOCR(권장)** 사용.
- 장점
  - 다국어(EN/FR/RU) 대응
  - 헤더/표지 같은 큰 글씨 인식 강점
  - bbox 제공 → evidence 저장에 최적
- 설정 팁
  - dpi: 200~300
  - angle classification ON
  - language: auto(가능하면) 또는 en+fr+ru 조합

#### OCR 엔진 대안 및 비교
실제 데이터로 비교 테스트 후 엔진을 선택한다. 문서 특성에 따라 최적 엔진이 다를 수 있다.

| 엔진 | 장점 | 단점 | 권장 상황 |
|------|------|------|-----------|
| **PaddleOCR** | 속도 빠름, bbox 정확 | 키릴 소문자 혼동 가능 | 일반적 첫 선택 |
| **Tesseract 5.x** | 키릴/악센트 안정적, 무료 | 레이아웃 분석 약함 | 러시아어/프랑스어 문서 |
| **EasyOCR** | 설치 간편, GPU 지원 | 속도 느림 | 손글씨 혼합 문서 |

초기 개발 시 동일 문서 세트(EN/FR/RU 각 10건)로 벤치마크를 수행하고, 필드별 정확도를 비교하여 기본 엔진을 확정한다.

### 단계 C: 폴백 OCR (정밀, 선택적)
다음 조건이면 상위 OCR을 “해당 페이지에만” 적용한다.
- 연도/저널명/시리즈명이 인식되지 않음
- 키릴/악센트 문자가 심하게 깨짐
- confidence가 낮음(예: 필드 추출 실패)

폴백 후보:
- ABBYY FineReader (정확도 최상, 비용 높음)
- Google Vision OCR (클라우드, 정확도 우수)
- Azure OCR 등

---

## 4. 언어 전략 (정확도에 영향 큼)

### 1) 스크립트 기반 언어 감지
- 키릴 문자 비율 높음 → RU
- 악센트(é, è, ç 등) 많음 → FR 가능성 상승
- 그 외 → EN

### 2) OCR 언어 파라미터 적용
- 가능하면 감지 결과에 따라 OCR 언어를 제한
- 제한이 어려우면 다국어 모드 사용 후 LLM 단계에서 정규화

---

## 5. 전처리(Pre-processing) 권장 사항

OCR 품질은 엔진 자체보다 전처리에서 크게 달라질 수 있다.

권장:
- 그레이스케일
- 약한 denoise
- (필요 시) adaptive threshold
- (필요 시) deskew(기울기 보정)

주의:
- 과한 threshold/샤프닝은 장식 서체/도판/숫자 인식을 망칠 수 있다.

---

## 6. OCR 출력 포맷 (서지 친화적 구조)

OCR 결과는 최소 다음을 포함한다.

```json
{
  "page": 1,
  "blocks": [
    {
      "text": "Bull. Soc. géol. France (7), IX, 1967, p. 750–757",
      "bbox": [x1, y1, x2, y2],
      "confidence": 0.93
    }
  ]
}
```

추가로 추천:
- `role_hint`: container_title / year / pages / authors / title 후보 등(후처리에서 부여)

---

## 7. 품질 평가(Heuristics)와 재시도 규칙

### 필드 기반 성공 조건 (예시)
- Year: 1개 이상
- Authors: 1명 이상
- Title: 1개 이상
- Container(저널/시리즈): 1개 이상
- (저널 논문이면) Pages 또는 Volume/Issue 중 최소 1개

### 재시도 트리거(폴백 또는 확장 탐색)
- Year가 없음
- Pages 패턴이 없음(저널 논문으로 분류된 경우)
- Container 불명확(저널/시리즈 후보가 2개 이상 충돌)
- OCR confidence 평균이 낮음(예: < 0.75)

#### Confidence 임계값 튜닝
`0.75`는 초기 기본값이며, 실제 운영 데이터로 튜닝이 필요하다.

튜닝 방법:
1. 초기 100건의 문서를 처리하며 confidence와 최종 정확도 기록
2. confusion matrix 분석: 폴백 없이 성공 / 폴백으로 성공 / 폴백해도 실패
3. precision-recall 균형점에서 임계값 조정 (보통 0.70~0.85 범위)

엔진별로 confidence 스케일이 다르므로, 엔진 변경 시 재튜닝 필수.

---

## 8. 에러 처리 및 엣지 케이스

### 처리해야 할 엣지 케이스
| 케이스 | 탐지 방법 | 대응 |
|--------|-----------|------|
| 빈 페이지 | 텍스트 블록 0개 | 다음 페이지로 대체 (p1→p3) |
| 이미지 전용 페이지 | OCR 결과 없음 + 이미지 존재 | 이미지 캡처만 저장, 스킵 |
| 회전된 페이지 | angle detection 결과 | 자동 회전 후 재OCR |
| 다단 레이아웃 | 컬럼 탐지 | 컬럼별 순서 정렬 후 병합 |
| 워터마크/도장 | 반복 패턴 + 투명도 낮음 | 마스킹 또는 무시 |

### 실패 시 최종 폴백
모든 시도 실패 시:
1. 원본 이미지와 부분 OCR 결과를 `needs_review` 상태로 저장
2. 사용자 UI에서 수동 입력 유도
3. 실패 케이스를 별도 로그에 기록하여 향후 개선 자료로 활용

---

## 9. 운영 팁 (실무)

- 전 페이지 OCR은 금지(최후의 수단)
- **p1/p2/last**만으로 끝나는 경우가 매우 많다.
- OCR은 "빠른 기본 + 실패 페이지 정밀 폴백"이 비용 대비 가장 좋다.
- 항상 evidence를 저장하면, 나중에 DB 정리·검증 비용이 급감한다.

---

## 10. 한 줄 요약
**OCR은 “빠르고 대충 → 실패한 것만 정밀”이 정답이며, 정확성은 OCR이 아니라 워크플로우 전체가 책임진다.**

