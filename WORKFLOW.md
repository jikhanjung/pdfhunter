# 서지 정보 자동 추출 에이전트 – 전체 워크플로우

## 개요
이 문서는 **스캔 PDF(비OCR) 또는 텍스트 PDF**로부터 서지 정보를 자동 추출하고,
필요 시 **웹 검색과 사용자 검수**를 결합하여 **확정 서지 레코드**를 생성하는
에이전트형 워크플로우를 단계별로 설명한다.

---

## 0. 입력과 출력 정의

### 입력
- PDF (텍스트 PDF 또는 스캔 PDF)
- 단일 이미지 (표지, 타이틀 페이지 등)

### 출력
- 서지 레코드 (CSL-JSON / RIS / BibTeX)
- evidence (근거): 페이지 번호 + 문자열/이미지 캡처
- status: confirmed / needs_review / failed

---

## 1. 파일 수집 및 기본 메타데이터 확인
1. 사용자가 파일을 드롭
2. 시스템이 즉시 확인
   - 페이지 수
   - 파일명
   - 생성일(있을 경우)
   - 텍스트 레이어 존재 여부
3. 분기
   - 텍스트 레이어 있음 → 텍스트 우선 파이프라인
   - 텍스트 레이어 없음 → OCR 파이프라인

---

## 2. 정보 가능성 높은 페이지 선택

### OCR 파이프라인 기본 전략
- 항상 선택: p1, p2, last
- 조건부 추가:
  - p3 (본문 시작)
  - last-1 (콜로폰이 한 장 앞에 있는 경우)
  - 목차 페이지 후보

### 텍스트 PDF 전략
- p1~p3
- last

---

## 3. 페이지 렌더링
- 선택된 페이지를 이미지로 렌더
- 저해상도: 탐지용
- 고해상도(200~300dpi): OCR 및 증거 저장용

---

## 4. 텍스트 추출

### OCR 문서
- 다국어 OCR (EN / FR / RU)
- 페이지별 결과 저장
  - ocr/p0001.txt
  - ocr/p0001.json (bounding box 포함 가능)

### 텍스트 PDF
- 텍스트 직접 추출
  - text/p0001.txt

---

## 5. 문서 유형 분류
OCR/텍스트에서 키워드 탐지

- 저널 논문: volume/issue, 페이지 범위, 런닝 헤더
- 기관 총서/시리즈: Выпуск, Bulletin No.
- 단행본/보고서: publisher/place/year 중심

---

## 6. 1차 규칙 기반 추출
정규식과 룰로 확실한 필드부터 추출

- Year: 19xx
- Pages: p. 123–130
- Series/Issue: Выпуск 13, Bulletin No. 115
- Volume: tome IX
- Place: Paris, Ленинград, Norman

각 필드는 반드시 evidence를 함께 기록

---

## 7. LLM 구조화 추출
룰로 불완전한 필드 보완

- Authors
- Title
- Container (저널/시리즈/기관)

LLM 출력은 JSON 스키마 강제
- fields
- evidence
- confidence

입력 데이터는 p1/p2/last 중심으로 제한

---

## 8. 내부 검증 및 점수화
- 필드 충돌 여부 확인
- 필수 필드 존재 여부 확인
- confidence 계산

예:
- 핵심 필드 충족 → 0.8+
- 페이지/권호 포함 → 0.9+
- 출판처/도시 포함 → 0.95+

---

## 9. 확장 탐색 루프 (에이전트 동작)
누락 필드가 있으면 자동 확장

- pages 누락 → 런닝 헤더 탐색
- publisher/place 누락 → last-1 추가
- volume/issue 누락 → 목차 탐색

시도 횟수 제한 필수

---

## 10. 웹 검색 보강 (선택)
내부 정보만으로 확정이 어려울 때 수행

- title + author + year
- 원어 제목 그대로 검색

웹 결과도 evidence로 저장

---

## 11. 최종 상태 결정
- confirmed: 핵심 필드 + 구조 필드 충족
- needs_review: 일부 불확실
- failed: 핵심 필드 다수 누락

---

## 12. 사용자 검수 UI
- 좌측: 근거 페이지 이미지
- 우측: 서지 필드 폼
- 상단: confidence 표시

버튼:
- 승인
- 수정 후 저장
- 웹검색 재시도
- 추가 OCR

---

## 13. 저장 및 내보내기
- records/{id}.csl.json
- evidence/ 디렉토리

내보내기:
- RIS
- BibTeX
- CSL-JSON

---

## 요약
**p1/p2/last OCR → 규칙 기반 확정 → LLM 구조화 → 페이지 확장 탐색 → 웹검색 보강 → 근거 저장 + 10초 검수**

이 워크플로우는 로컬 MVP부터 서버/에이전트 확장까지 자연스럽게 이어진다.

